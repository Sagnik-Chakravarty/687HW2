# Question 1
```{r setup}
library(tidyverse)
library(nlme)
library(lme4)
library(geepack)
library(broom)
library(broom.mixed)

theme_set(theme_minimal())

load("/Users/sagnikchakravarty/Downloads/hrs_wbbp_long.rda")

hrs <- hrs_wbbp_long %>%
	mutate(
		RAGENDER = factor(RAGENDER, levels = c(1, 2), labels = c("Male", "Female"))
	) %>%
	arrange(HHIDPN, year) %>%
	group_by(HHIDPN) %>%
	mutate(
		age0 = first(age_y),
		htn = as.integer(bp_sys >= 140)
	) %>%
	ungroup()

age0_mean <- mean(hrs$age0, na.rm = TRUE)

hrs <- hrs %>%
	mutate(
		age0_c = age0 - age0_mean,
		year_factor = factor(year)
	)
```

```{r q1_summary}
summary_tbl <- tibble(
	participants = n_distinct(hrs$HHIDPN),
	observations = nrow(hrs),
	mean_visits = hrs %>% count(HHIDPN) %>% pull(n) %>% mean(),
	mean_baseline_age = age0_mean
)

knitr::kable(summary_tbl, digits = 1)
```

```{r q1_spaghetti, fig.width=8, fig.height=5}
ggplot(hrs, aes(x = year, y = bp_sys, group = HHIDPN, color = RAGENDER)) +
	geom_line(alpha = 0.25) +
	stat_summary(aes(group = RAGENDER), fun = mean, geom = "line", linewidth = 1.2, 
    alpha = 0.9) +
	scale_color_brewer(palette = "Set1") +
	labs(
		x = "Years Since Baseline",
		y = "Systolic BP (mmHg)",
		color = "Sex",
		title = "Individual and Mean Trajectories"
	)
```

```{r q1_avg, fig.width=7, fig.height=4}
avg_bp <- hrs %>%
	group_by(year, RAGENDER) %>%
	summarise(mean_bp = mean(bp_sys), .groups = "drop")

ggplot(avg_bp, aes(x = year, y = mean_bp, color = RAGENDER)) +
	geom_line(linewidth = 1.1) +
	geom_point(size = 2.5) +
	scale_color_brewer(palette = "Set1") +
	labs(
		x = "Years Since Baseline",
		y = "Mean Systolic BP (mmHg)",
		color = "Sex",
		title = "Mean Trajectories by Sex"
	)
```

# Question 2

```{r q2_models}
model_formulas <- list(
	linear = bp_sys ~ age0_c + RAGENDER + year,
	quadratic = bp_sys ~ age0_c + RAGENDER + poly(year, 2, raw = TRUE),
	cubic = bp_sys ~ age0_c + RAGENDER + poly(year, 3, raw = TRUE)
)

gls_models <- purrr::map(
	model_formulas,
	~ gls(
		.x,
		data = hrs,
		correlation = corCompSymm(form = ~ 1 | HHIDPN),
		na.action = na.omit,
		method = "ML"
	)
)

aic_comparison <- tibble(
	model = names(gls_models),
	AIC = purrr::map_dbl(gls_models, AIC),
	logLik = purrr::map_dbl(gls_models, ~ as.numeric(logLik(.x)))
) %>%
	arrange(AIC)

best_model_name <- aic_comparison$model[1]
best_gls <- gls_models[[best_model_name]]
best_formula <- model_formulas[[best_model_name]]

knitr::kable(aic_comparison, digits = 2)
```


# Question 3
```{r q3_coefs}
gls_coefs <- tidy(best_gls, conf.int = TRUE)
knitr::kable(gls_coefs, digits = 3)
```

# Question 4

```{r q4_corr}
gls_ar1 <- gls(
	best_formula,
	data = hrs,
	correlation = corAR1(form = ~ year | HHIDPN),
	na.action = na.omit,
	method = "ML"
)

gls_unstruct <- gls(
	best_formula,
	data = hrs,
	correlation = corSymm(form = ~ 1 | HHIDPN),
	weights = varIdent(form = ~ 1 | year_factor),
	na.action = na.omit,
	method = "ML",
	control = glsControl(msMaxIter = 200)
)

alt_aic <- tibble(
	correlation = c("exchangeable", "ar1", "unstructured"),
	AIC = c(AIC(best_gls), AIC(gls_ar1), AIC(gls_unstruct)),
	logLik = c(
		as.numeric(logLik(best_gls)),
		as.numeric(logLik(gls_ar1)),
		as.numeric(logLik(gls_unstruct))
	)
) %>%
	arrange(AIC)
```

```{r}
first_group <- as.character(unique(getGroups(best_gls))[1])
cor_exchange <- round(as.matrix(cov2cor(getVarCov(best_gls, individual = first_group))), 3)
cor_ar1 <- round(as.matrix(cov2cor(getVarCov(gls_ar1, individual = first_group))), 3)
cor_unstruct <- round(as.matrix(cov2cor(getVarCov(gls_unstruct, individual = first_group))), 3)

knitr::kable(alt_aic, digits = 2, caption = "Model fit by working correlation")
knitr::kable(cor_exchange, caption = "Exchangeable correlation (scaled)")
knitr::kable(cor_ar1, caption = "AR(1) correlation (scaled)")
knitr::kable(cor_unstruct, caption = "Unstructured correlation (scaled)")
```

## Question 5

```{r q5_models, include=FALSE}
logit_m1 <- glmer(
	htn ~ year + (year | HHIDPN),
	data = hrs,
	family = binomial,
	control = glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 2e5))
)

logit_m1_tbl <- tidy(logit_m1, effects = "fixed", conf.int = TRUE) %>%
	mutate(
		odds_ratio = exp(estimate),
		conf.low.or = exp(conf.low),
		conf.high.or = exp(conf.high)
	) %>%
	select(term, estimate, std.error, conf.low, conf.high, odds_ratio, conf.low.or, conf.high.or)

logit_m2 <- glmer(
	htn ~ year + RAGENDER + age0_c + (year | HHIDPN),
	data = hrs,
	family = binomial,
	control = glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 2e5))
)

logit_m2_tbl <- tidy(logit_m2, effects = "fixed", conf.int = TRUE) %>%
	mutate(
		odds_ratio = exp(estimate),
		conf.low.or = exp(conf.low),
		conf.high.or = exp(conf.high)
	) %>%
	select(term, estimate, std.error, conf.low, conf.high, odds_ratio, conf.low.or, conf.high.or)

logit_m2_var <- as.data.frame(VarCorr(logit_m2)) %>%
	select(grp, var1, var2, vcov, sdcor)
```
```{r}
gee_m <- geeglm(
	htn ~ year + RAGENDER + age0_c,
	id = HHIDPN,
	data = hrs,
	family = binomial,
	corstr = "exchangeable"
)

gee_tbl <- tidy(gee_m, conf.int = TRUE) %>%
	mutate(
		odds_ratio = exp(estimate),
		conf.low.or = exp(conf.low),
		conf.high.or = exp(conf.high)
	) %>%
	select(term, estimate, std.error, conf.low, conf.high, odds_ratio, conf.low.or, conf.high.or)

gee_alpha <- summary(gee_m)$working.correlation[1, 2]
```

```{r q5_table}
knitr::kable(logit_m1_tbl, digits = 3)
```


## Question 6

```{r q6_table}
knitr::kable(logit_m2_tbl, digits = 3)
```